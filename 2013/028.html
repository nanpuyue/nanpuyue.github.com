<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>搭建基于OpenWrt、gPXE和iSCSI的Windows无盘工作站 | 南浦月</title>
  <meta name="author" content="南浦月">

  
  <meta name="description" content="本文要介绍的是如何在OpenWrt平台上面搭建无盘工作站服务器以及Windows的iSCSI部署。当然，由于OpenWrt也可以算得上一种Linux发行版了，所以本文所介绍的一些方法，在其它Linux发行版上面仍有一定的参考价值。  
整个过程大概分为以下几步：  

给OpenWrt添加iSCSI">
  
  

  <link rel="alternate" href="/atom.xml" title="南浦月" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35959106-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/links">链接</a></li>
    
      <li><a href="/live">直播</a></li>
    
      <li><a href="/about">关于</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="title">搭建基于OpenWrt、gPXE和iSCSI的Windows无盘工作站</h1>
  

    <time datetime="2013-02-22T05:29:00.000Z">
  <span class="day">22</span><span class="month">2月</span>
</time>
  </header>
  <div class="entry-content">
    
      <p>本文要介绍的是如何在OpenWrt平台上面搭建无盘工作站服务器以及Windows的iSCSI部署。<br>当然，由于OpenWrt也可以算得上一种Linux发行版了，所以本文所介绍的一些方法，在其它Linux发行版上面仍有一定的参考价值。  </p>
<p>整个过程大概分为以下几步：  </p>
<ul>
<li>给OpenWrt添加iSCSI Target支持</li>
<li>创建并配置iSCSI Target</li>
<li>获取gPXE并配置DHCP及TFTP服务</li>
<li>通过iSCSI部署Windows</li>
<li>测试</li>
</ul>
<h3 id="给OpenWrt添加iSCSI_Target支持">给OpenWrt添加iSCSI Target支持</h3>
<p>到写作本文为止，貌似OpenWrt官方还没有添加iSCSI Target支持相关的软件包，所以我们需要自力更生。然而幸运的是，已经有前人做过了类似的事情，我们只要采取“拿来主义”即可。  </p>
<p>相关资源：<br><a href="https://github.com/tobiaswaldvogel/openwrt-addpack/tree/master/scst" target="_blank">https://github.com/tobiaswaldvogel/openwrt-addpack/tree/master/scst</a><br><a href="https://github.com/tobiaswaldvogel/openwrt-addpack/tree/master/luci-app-scst" target="_blank">https://github.com/tobiaswaldvogel/openwrt-addpack/tree/master/luci-app-scst</a><br>上面分别是在OpenWrt的内核层面实现的iSCSI Target支持及其Luci配置界面，读者需要自行获取这两部分的源码然后进行交叉编译，这也是我最终选用的方案，下文关于iSCSI的内容均基于此。  </p>
<p>另外还有一个在用户空间实现的方案，详情见：<br><a href="https://dev.openwrt.org/ticket/8798" target="_blank">https://dev.openwrt.org/ticket/8798</a><br><a href="http://patchwork.openwrt.org/patch/2597" target="_blank">http://patchwork.openwrt.org/patch/2597</a>  </p>
<p>无论上面哪种方案，就目前而言都需要读者自行编译，但是如何交叉编译OpenWrt所需的软件包不在本文的讨论范围。  </p>
<p>采用第一种方案，进行交叉编译后，会得到以下几个软件包：  </p>
<ul>
<li>kmod-iscsi-scst</li>
<li>kmod-scst</li>
<li>kmod-scst-vdisk</li>
<li>scst</li>
<li>luci-app-scst</li>
</ul>
<p>把它们安装到OpenWrt，这样第一步添加iSCSI Target支持就算完成了。  </p>
<h3 id="创建并配置iSCSI_Target">创建并配置iSCSI Target</h3>
<p>要创建iSCSI Target需要路由器有足够大的存储空间，最好是在路由器上挂载移动硬盘，如果是U盘则最小需要16G的U盘，而且U盘的性能可能会差很多。<br>在进入下面的配置之前，我们需要创建一个固定大小的虚拟磁盘文件，你可以将移动硬盘连接到电脑上进行创建(Windows下创建一个VHD虚拟磁盘文件即可，至于要不要初始化该虚拟磁盘，则需要根据下面的操作决定，所以我建议先不要初始化)，也可以直接在路由器上面创建，直接在路由器上面创建需要使用<code>dd</code>命令，假设你的移动硬盘被挂载到<code>/mnt/sda1</code>,则可以使用下面的命令创建一个15G的文件：  </p>
<pre><code>mkdir /mnt/sda1/iscsi
dd <span class="keyword">if</span>=<span class="regexp">/dev/zero</span> of=<span class="regexp">/mnt/sda</span>1/iscsi/disk1.vhd bs=<span class="number">1</span>M count=<span class="number">15360</span>
</code></pre><p>创建文件的过程需要较长时间，请耐心等待，同时你可以另开一个终端登录路由器，并使用  </p>
<pre><code>du -h /mnt/sda1/iscsi/disk1<span class="preprocessor">.vhd</span>
</code></pre><p>查看文件大小。  </p>
<p>虚拟磁盘文件创建完成后，进入iSCSI Target的Web管理界面(<code>服务</code>-&gt;<code>iSCSI Target</code>)。</p>
<p>先是“Global settings”(全局设置)，里面只有一个“System ID”，就是iSCSI Qualified Name(即ipn)。<br>默认的设置是“iqn.2012-12.org.openwrt”，建议不要更改，至于其命名规范，可参考<a href="http://tools.ietf.org/html/rfc3721#page-5" target="_blank">rfc3721</a>中相关内容。  </p>
<p>然后是“Devices”(设备)，单击<code>添加</code>，添加一个Device，共享名随意(如<code>disk1</code>)，类型只有一个选项——“Image file”，“目录”即虚拟磁盘文件的路径(如<code>/mnt/sda1/iscsi/disk1.vh</code>)。<br>紧接着是“Tagets”，同样单击<code>添加</code>，共享名随意(如<code>iscsiboot</code>)，“Lun”则需填写上面添加的Device的共享名(如<code>disk1</code>)，设置好后别忘了点击<code>保存&amp;应用</code>。  </p>
<p>上面的设置，也可以通过编辑配置文件(<code>/etc/config/scst</code>)完成：  </p>
<pre><code>config global
    <span class="built_in">option</span> id <span class="string">'iqn.2012-12.org.openwrt'</span>

config target
    <span class="built_in">option</span> name <span class="string">'iscsiboot'</span>
    <span class="built_in">list</span> lun <span class="string">'disk1'</span>

config device
    <span class="built_in">option</span> <span class="class"><span class="keyword">type</span> '<span class="title">file</span>'</span>
    <span class="built_in">option</span> blocksize <span class="string">'512'</span>
    <span class="built_in">option</span> name <span class="string">'disk1'</span>
    <span class="built_in">option</span> path <span class="string">'/mnt/sda1/iscsi/disk1.vhd'</span>
</code></pre><p>最后，需要开启scst服务：  </p>
<pre><code>/etc/init<span class="preprocessor">.d</span>/scst enable
/etc/init<span class="preprocessor">.d</span>/scst start
</code></pre><p>如果start失败的话，可能需要重启路由器：  </p>
<pre><code>reboot
</code></pre><p>未完待续……</p>

    
    
    <footer class="meta">
      
  <div class="cats">
<a href="/categories/Linux/">Linux</a><a href="/categories/Linux/OpenWrt/">OpenWrt</a></div>

      
  <div class="tags">
<a href="/tags/Windows/">Windows</a><a href="/tags/无盘工作站/">无盘工作站</a><a href="/tags/Linux/">Linux</a><a href="/tags/iSCSI/">iSCSI</a></div>

      
    </footer>
    
  </div>
  
<section id="comment">
  <div id="disqus_thread" aria-live="polite">
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</article></div>
  <footer id="footer" class="inner"><div class="social alignright">
  
    <a class="facebook" href="https://www.facebook.com/nanpuyue" title="Facebook">Facebook</a>
  
  
    <a class="google" href="https://plus.google.com/+nanpuyue" title="Google+">Google+</a>
  
  
    <a class="twitter" href="https://twitter.com/nanpuyue" title="Twitter">Twitter</a>
  
  
    <a class="github" href="https://github.com/nanpuyue" title="GitHub">GitHub</a>
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>

<div align="left">
  
  &copy; 2012-2014 <a href="http://blog.nanpuyue.com"> 南浦月 </a>
  
</div>

<div class="clearfix"></div>
</footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'nanpuyue';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>
<script src="/js/phasebeam.js"></script>
</body>
</html>