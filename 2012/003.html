<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>OH3C的安装及使用 H3C 802.1x Client for OpenWrt | 南浦月</title>
  <meta name="author" content="南浦月">

  
  <meta name="description" content="OH3C是基于Openwrt路由器固件平台的H3C 802.1x兼容客户端，基于YaH3C开发。
目前已经实现的功能有：

H3C 802.1x认证
多用户管理
mac绑定设置及自动修改mac

项目主页：Github：https://github.com/nanpuyue/oh3cGoogle C">
  
  

  <link rel="alternate" href="/atom.xml" title="南浦月" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35959106-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/links">链接</a></li>
    
      <li><a href="/live">直播</a></li>
    
      <li><a href="/about">关于</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="title">OH3C的安装及使用 H3C 802.1x Client for OpenWrt</h1>
  

    <time datetime="2012-03-22T04:00:00.000Z">
  <span class="day">22</span><span class="month">3月</span>
</time>
  </header>
  <div class="entry-content">
    
      <p>OH3C是基于Openwrt路由器固件平台的H3C 802.1x兼容客户端，基于YaH3C开发。</p>
<p>目前已经实现的功能有：</p>
<ul>
<li>H3C 802.1x认证</li>
<li>多用户管理</li>
<li>mac绑定设置及自动修改mac</li>
</ul>
<p>项目主页：<br>Github：<a href="https://github.com/nanpuyue/oh3c" target="_blank">https://github.com/nanpuyue/oh3c</a><br>Google Code：<a href="https://code.google.com/p/oh3c" target="_blank">https://code.google.com/p/oh3c</a>  </p>
<p>下载：<br><a href="https://code.google.com/p/oh3c/downloads/list" target="_blank">https://code.google.com/p/oh3c/downloads/list</a>  </p>
<h2 id="前提">前提</h2>
<p>首先要会用ssh登录路由器，但是如果是首次将路由器刷成openwrt或者复位过设置，那么路由器是没有密码，也不会允许ssh登录的，解决方法是使用telnet登录或者web登录设置密码。在windows下面telnet和ssh登录可以使用<a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_blank">Putty</a>。<br><img src="https://lh3.googleusercontent.com/-bUwNCZtKOSs/UfARRB4yVYI/AAAAAAAAAZg/Wfff7Y1E4Wc/s0/telnet.png" alt="Putty telnet"><br><img src="https://lh4.googleusercontent.com/-1IZ5YCfdNM8/UfARMcr-xjI/AAAAAAAAAZI/N8xBvutIZdQ/s0/ssh.png" alt="Putty ssh"><br>你还可以在Saved Sessions下面填上一个名称，然后点击保存，以后直接在下面点击这个名称，再点Load、Open就可以登录了。 需要注意的是登录ssh是需要输入你设置的密码，但是密码不会显示，对，连星号都不会显示，只管输入就是了。<br><img src="https://lh6.googleusercontent.com/-MpB2v7dgSIE/UfARN8ruTWI/AAAAAAAAAZY/NVNwBWN8qpI/s0/ssh_login.png" alt="ssh login"></p>
<h2 id="依赖">依赖</h2>
<ul>
<li>python-mini</li>
</ul>
<p>或者使用python-mini-oh3c代替，python-mini-oh3c在<a href="https://code.google.com/p/oh3c/downloads/list" target="_blank">本项目下载页面</a>下载。 下面是快速下载链接：<br><a href="https://oh3c.googlecode.com/files/python-mini-oh3c_2.6.4-4_ar71xx.ipk" target="_blank">python-mini-oh3c_2.6.4-4_ar71xx.ipk</a><br><a href="https://oh3c.googlecode.com/files/python-mini-oh3c_2.6.4-4_brcm63xx.ipk" target="_blank">python-mini-oh3c_2.6.4-4_brcm63xx.ipk</a><br><a href="https://oh3c.googlecode.com/files/python-mini-oh3c_2.7.3-1_ar71xx.ipk" target="_blank">python-mini-oh3c_2.7.3-1_ar71xx.ipk</a><br>一般的openwrt固件不包含python的支持，所以你可以自行编译一个带python-mini的固件，或者直接在路由器里面利用包管理软件安装python-mini(路由器须联网):  </p>
<pre><code>opkg <span class="operator"><span class="keyword">update</span>
opkg install python-mini</span>
</code></pre><p>如果无法联网，可以下载python-mini或者python-mini-oh3c，上传到路由器的/tmp目录，建议windows用户使用<a href="http://winscp.net/eng/docs/lang:chs" target="_blank">Winscp</a>上传文件！再ssh登录路由器安装：  </p>
<pre><code>opkg <span class="keyword">install</span> /tmp/python-mini*.ipk
</code></pre><p>安装时如果提示依赖zlib而无法安装，请<a href="http://downloads.openwrt.org/attitude_adjustment/12.09-rc1/" target="_blank">下载zlib</a>上传到路由器/tmp目录。 先安装zlib，再安装python-mini或python-mini-oh3c：  </p>
<pre><code>opkg <span class="keyword">install</span> /tmp/zlib*.ipk
opkg <span class="keyword">install</span> /tmp/python-mini*.ipk
</code></pre><h2 id="安装OH3C">安装OH3C</h2>
<p>OH3C目前有两个版本，一个web界面控制版，需luci支持：luci-app-oh3c，还有一个命令行版，没有web界面，两个版本不能共存，只能任选其一。<br>如果你使用的是trunk版的openwrt，建议使用luci-app-oh3c:<br><a href="https://oh3c.googlecode.com/files/luci-app-oh3c_2013-2-6_all.ipk" target="_blank">luci-app-oh3c_2013-2-6_all.ipk</a><br>带Web界面的版本可以使用命令传递参数使用，用法是：  </p>
<pre><code>python /usr/oh3c/oh3c.py <span class="tag">&lt;<span class="title">username</span>&gt;</span> <span class="tag">&lt;<span class="title">password</span>&gt;</span> <span class="tag">&lt;<span class="title">dev</span>&gt;</span> <span class="tag">&lt;<span class="title">mac</span>&gt;</span>
</code></pre><p>如果不绑定mac，mac一项可以使用default，下面是自启脚本，只适用于带web界面的版本：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="comment">#!/bin/sh /etc/rc.common</span>
<span class="comment"># Copyright (C) 2012 OpenWrt.org</span>
<span class="comment"># Copyright (C) 2013 nanpuyue@gmail.com</span>

START=<span class="number">90</span>

current=`uci get oh3ctest.@control[<span class="number">0</span>].current`
ifname=`uci get oh3ctest.@control[<span class="number">0</span>].ifname`

<span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="number">0</span> <span class="number">10</span>`;<span class="keyword">do</span>
	username=`uci get oh3ctest.@userinfo[<span class="variable">$i</span>].username`;
	<span class="keyword">if</span> [ <span class="variable">$username</span> = <span class="variable">$current</span> ];<span class="keyword">then</span>
		password=`uci get oh3ctest.@userinfo[<span class="variable">$i</span>].password`
		macaddr=`uci get oh3ctest.@userinfo[<span class="variable">$i</span>].macaddr`
		<span class="keyword">break</span>
	<span class="keyword">fi</span>;
<span class="keyword">done</span>

<span class="function"><span class="title">start</span></span>() {
python /usr/oh3c/oh3c.py <span class="variable">$current</span> <span class="variable">$password</span> <span class="variable">$ifname</span> <span class="variable">$macaddr</span> &gt;&gt; /tmp/log/oh3c
}

<span class="function"><span class="title">stop</span></span>() {
pid=`ps | grep /usr/oh3c/oh3c.py | grep -v grep | awk <span class="string">'{printf $1}'</span>`
<span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$pid</span>"</span> ];<span class="keyword">then</span>
	kill <span class="variable">$pid</span>
<span class="keyword">fi</span>
}

<span class="function"><span class="title">restart</span></span>() {
stop
start
}
</pre></td></tr></table></figure>

<p>将脚本保存为<code>/etc/init.d/oh3c</code>，运行<code>/etc/init.d/oh3c enable</code>启用自启动。  </p>
<p>dreambox由于暂时有兼容性问题，所以不能使用带luci界面支持的，请下载下面命令行版本包：<br><a href="https://oh3c.googlecode.com/files/oh3c_2013-2-6_all.ipk" target="_blank">oh3c_2013-2-6_all.ipk</a>  </p>
<p>在Linux下使用命令行上传文件想来对于Linux用户不是难事，就略过了。  </p>
<h2 id="使用OH3C">使用OH3C</h2>
<p>安装luci-app-oh3c的童鞋，使用浏览器从web端登录路由器，OH3C控制入口在Network[网络]——OH3C。 另外建议使用主题bootstrap:  </p>
<pre><code>opkg update
opkg install luci<span class="attribute">-theme</span><span class="attribute">-bootstrap</span>
</code></pre><p>点击Add[添加]添加用户，设置好用户名、密码，如果有需要，切换到Advanced Settings[高级设置]标签设置连网设备及mac。 然后点击Save[保存],要注意的是，新添加的用户<strong>要点两次Save[保存]</strong>才能在下面的Current user中选择。 点击Save&amp;Appy[保存&amp;应用]连网。 目前无法显示连网状态，如果再次点击Save&amp;Appy[保存&amp;应用]会断网。<br><img src="https://lh3.googleusercontent.com/--gzWhbLOakk/UfARFuNg7RI/AAAAAAAAAY4/gKI80m8qw3g/s0/oh3c_01.png" alt="OH3C_1"><br>要切换用户，只需要在Current user中选择相应的用户，依次点击Save[保存]和Save&amp;Appy[保存&amp;应用]即可。<br><img src="https://lh5.googleusercontent.com/-vjHeqH63uN0/UfARF5FhRxI/AAAAAAAAAY8/bAgbK-oxAC4/s0/oh3c_02.png" alt="OH3C_2"></p>
<p>需要注意的是，如果你使用的mac绑定功能，这时会修改路由器wan口的mac地址，所以相应时间会久一些，还有极少数情况连接失败，这时请再次点击Save&amp;Appy[保存&amp;应用]。 web版的OH3C连接时不会有屏幕输出信息，但是所有输出信息都保存在/tmp/log/oh3c中，重启路由器后消失，如果使用中遇到问题，可以将此文件中的内容贴出来。</p>
<p>使用命令行版本的童鞋，先使用ssh登录路由器，输入命令：  </p>
<pre><code>oh3c
</code></pre><p>然后按提示操作即可。</p>
<p>从V0.2开始，OH3C加入了mac设置项，以方便mac绑定的情况，如果你不需要设置mac，命令行版本请在设置帐号要求输入mac时直接回车，web版请保持默认的default，这样该帐号联网时就不会更改mac，而保持之前的mac设置。</p>
<p>另外，如果你的路由器仅有4M flash，建议自己编译固件，你可以在编译openwrt时去掉和PPP和PPPOE相关的包，这样固件体积会缩小很多。</p>
<p>如果使用中有任何问题，欢迎反馈：<br><a href="https://code.google.com/p/oh3c/issues/list" target="_blank">https://code.google.com/p/oh3c/issues/list</a></p>

    
    
    <footer class="meta">
      
  <div class="cats">
<a href="/categories/Linux/">Linux</a><a href="/categories/Linux/OpenWrt/">OpenWrt</a></div>

      
  <div class="tags">
<a href="/tags/802.1x/">802.1x</a><a href="/tags/OH3C/">OH3C</a><a href="/tags/OpenWrt/">OpenWrt</a><a href="/tags/开源/">开源</a><a href="/tags/校园网/">校园网</a></div>

      
    </footer>
    
  </div>
  
<section id="comment">
  <div id="disqus_thread" aria-live="polite">
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</article></div>
  <footer id="footer" class="inner"><div class="social alignright">
  
    <a class="facebook" href="https://www.facebook.com/nanpuyue" title="Facebook">Facebook</a>
  
  
    <a class="google" href="https://plus.google.com/+nanpuyue" title="Google+">Google+</a>
  
  
    <a class="twitter" href="https://twitter.com/nanpuyue" title="Twitter">Twitter</a>
  
  
    <a class="github" href="https://github.com/nanpuyue" title="GitHub">GitHub</a>
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>

<div align="left">
  
  &copy; 2012-2014 <a href="http://blog.nanpuyue.com"> 南浦月 </a>
  
</div>

<div class="clearfix"></div>
</footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'nanpuyue';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>
<script src="/js/phasebeam.js"></script>
</body>
</html>